rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Usuarios
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
      // Permitir actualizar role cuando se vincula un hijo
      allow update: if request.auth != null &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role', 'updatedAt']) &&
        request.resource.data.role == 'parent';

      // Dispositivos del usuario
      match /devices/{deviceId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Parent-children relationships
    match /parent_children/{docId} {
      allow read: if request.auth != null &&
        (resource.data.parentId == request.auth.uid ||
         resource.data.childId == request.auth.uid);
      allow write: if request.auth != null;
    }

    // Parent-child links
    match /parent_child_links/{docId} {
      allow read: if request.auth != null &&
        (resource.data.parentId == request.auth.uid ||
         resource.data.childId == request.auth.uid);
      allow write: if request.auth != null;
    }

    // Chats
    match /chats/{chatId} {
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.participants;
      allow write: if request.auth != null;

      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // Messages (colecci√≥n global)
    match /messages/{messageId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Contactos
    match /contacts/{contactId} {
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.users;
      allow write: if request.auth != null;
    }

    // Notificaciones
    match /notifications/{notificationId} {
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;
      allow write: if request.auth != null;
    }

    // Actividades
    match /activities/{activityId} {
      allow read: if request.auth != null &&
        resource.data.parentId == request.auth.uid;
      allow write: if request.auth != null;
    }

    // Alertas
    match /alerts/{alertId} {
      allow read: if request.auth != null &&
        resource.data.parentId == request.auth.uid;
      allow write: if request.auth != null;
    }

    // Story approval requests
    match /story_approval_requests/{requestId} {
      allow read: if request.auth != null &&
        (resource.data.parentId == request.auth.uid ||
         resource.data.childId == request.auth.uid);
      allow write: if request.auth != null;
    }

    // Stories
    match /stories/{storyId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Grupos
    match /groups/{groupId} {
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.members;
      allow write: if request.auth != null;

      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // Parent approval requests
    match /parent_approval_requests/{requestId} {
      allow read: if request.auth != null &&
        (resource.data.existingParentId == request.auth.uid ||
         resource.data.newParentId == request.auth.uid ||
         resource.data.childId == request.auth.uid);
      allow write: if request.auth != null;
    }

    // Link codes
    match /link_codes/{codeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Locations
    match /locations/{locationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Video calls
    match /video_calls/{callId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Chat permissions
    match /chat_permissions/{permissionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // User locations
    match /user_locations/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Location history
    match /location_history/{locationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Whitelist
    match /whitelist/{whitelistId} {
      allow read: if request.auth != null &&
        (resource.data.childId == request.auth.uid ||
         resource.data.parentId == request.auth.uid);
      allow write: if request.auth != null;
    }
  }
}
